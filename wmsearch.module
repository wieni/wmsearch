<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\wmsearch\Exception\ApiException;

/**
 * Queue entities to be added/removed to/from the index.
 */
function wmsearch_queue(EntityInterface $e)
{
    \Drupal::service('queue')
        ->get('wmsearch.index')
        ->createItem(
            [
                'type' => $e->getEntityTypeId(),
                'language' => $e->language()->getId(),
                'id' => $e->id(),
            ]
        );
}

function wmsearch_entity_delete(EntityInterface $e)
{
    wmsearch_queue($e);
}

function wmsearch_entity_update(EntityInterface $e)
{
    wmsearch_queue($e);
}

function wmsearch_entity_insert(EntityInterface $e)
{
    wmsearch_queue($e);
}

function wmsearch_entity_id(EntityInterface $e)
{
    $id = $e->id();
    if (!$id) {
        throw new \RuntimeException(
            'Can not retrieve the elastic id for an entity without id'
        );
    }

    return wmsearch_id(
        $e->getEntityTypeId(),
        $e->language()->getId(),
        $id
    );
}

function wmsearch_id($type, $language, $id)
{
    return sprintf('%s:%s:%s', $type, $language, $id);
}

function wmsearch_rebuild()
{
    // Doesn't feel right, more appropriate place to do this.
    // ... what if elastic is down? no more drush cr?
    try {
        \Drupal::service('wmsearch.api')->createIndex();
    } catch (ApiException $e) {
        if (!$e->isIndexExists()) {
            throw $e;
        }
    }
}

